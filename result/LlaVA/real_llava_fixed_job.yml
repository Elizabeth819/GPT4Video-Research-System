# çœŸæ­£çš„LLaVAæ£€æµ‹ä½œä¸š - ä¿®å¤ç‰ˆ
$schema: https://azuremlschemas.azureedge.net/latest/commandJob.schema.json
type: command

# Job metadata
display_name: real-llava-fixed-detection
description: "Real LLaVA Ghost Probing Detection using decord for video frame extraction and LLaVA-NeXT for analysis"

# Compute configuration  
compute: azureml:llava-a100-low-priority
environment: azureml:AzureML-ACPT-pytorch-1.13-py38-cuda11.7-gpu:10

# Resource requirements
resources:
  instance_count: 1

# Code source
code: .

# Real LLaVA analysis with proper dependencies
command: >
  echo "ğŸš€ å¼€å§‹çœŸæ­£çš„LLaVAé¬¼æ¢å¤´æ£€æµ‹ä½œä¸š" &&
  python --version &&
  echo "ğŸ“‹ æ£€æŸ¥GPUå’ŒCUDAç¯å¢ƒ..." &&
  nvidia-smi &&
  python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDAå¯ç”¨: {torch.cuda.is_available()}'); print(f'GPUæ•°é‡: {torch.cuda.device_count()}' if torch.cuda.is_available() else 'No GPU')" &&
  echo "ğŸ”§ å®‰è£…ä¾èµ–åŒ…..." &&
  pip install decord transformers accelerate Pillow &&
  echo "ğŸ“ æ£€æŸ¥è¾“å…¥æ•°æ®è·¯å¾„..." &&
  echo "å½“å‰å·¥ä½œç›®å½•:" &&
  pwd &&
  echo "æ£€æŸ¥è§†é¢‘æ–‡ä»¶:" &&
  python -c "
import os
azureml_data_path = os.environ.get('AZUREML_DATAREFERENCE_video_data')
if azureml_data_path:
    print(f'æ•°æ®è·¯å¾„: {azureml_data_path}')
    import os
    if os.path.exists(azureml_data_path):
        videos = [f for f in os.listdir(azureml_data_path) if f.endswith('.avi')]
        print(f'æ‰¾åˆ° {len(videos)} ä¸ª.aviæ–‡ä»¶')
        for i, v in enumerate(videos[:5]):
            print(f'  {i+1}: {v}')
        if len(videos) > 5:
            print(f'  ... è¿˜æœ‰ {len(videos)-5} ä¸ªæ–‡ä»¶')
    else:
        print('æ•°æ®è·¯å¾„ä¸å­˜åœ¨')
else:
    print('æœªæ‰¾åˆ°AZUREML_DATAREFERENCE_video_dataç¯å¢ƒå˜é‡')
" &&
  echo "ğŸ“Š è¿è¡ŒçœŸæ­£çš„LLaVAæ£€æµ‹..." &&
  timeout 7200 python real_llava_detector_fixed.py &&
  echo "âœ… çœŸæ­£çš„LLaVAé¬¼æ¢å¤´æ£€æµ‹ä½œä¸šå®Œæˆ"

# Input data  
inputs:
  video_data:
    type: uri_folder
    path: azureml:dada-100-videos-fixed:1
    mode: ro_mount

# Output data
outputs:
  results:
    type: uri_folder
    mode: rw_mount

# Experiment settings
experiment_name: real-llava-fixed-experiment